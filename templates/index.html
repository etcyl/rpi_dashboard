<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Raspberry Pi title color */
        h1 {
            color: #d62627; /* Raspberry Pi color */
        }

        /* Loader CSS */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollable command output */
        .scrollable-output {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Raspberry Pi Dashboard</h1>

        <!-- Available RPIs Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Available RPIs</h5>
                <div id="rpi-list" class="list-group">
                    {% for ip, hostname in active_rpis.items() %}
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        {{ hostname }} ({{ ip }})
                        <span>
                            <button class="btn btn-primary btn-sm" onclick="fetchMetrics('{{ ip }}')">Run vcgencmd test</button>
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Test Output Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Test Output</h5>
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">RPI</th>
                            <th scope="col">Core Voltage (V)</th>
                            <th scope="col">CPU Temp (Â°C)</th>
                            <th scope="col">CPU Frequency (MHz)</th>
                            <th scope="col">Load Average</th>
                            <th scope="col">Memory Usage</th>
                            <th scope="col">Throttled Status</th>
                        </tr>
                    </thead>
                    <tbody id="test-output-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Run All Command Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Run Command on All RPIs</h5>
                <div class="input-group mb-3">
                    <input type="text" id="custom-command" class="form-control" placeholder="Enter command">
                    <button class="btn btn-primary" onclick="runAllCommand()">Run All Command</button>
                </div>
                <div id="command-output" class="scrollable-output mt-2"></div>
            </div>
        </div>

        <!-- Run All Tests Configuration Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Run All Tests</h5>
                <form id="test-config-form">
                    <div class="mb-3">
                        <label for="duration" class="form-label">Test Duration (Hours)</label>
                        <input type="number" id="duration" class="form-control" placeholder="Enter hours" min="1">
                    </div>
                    <div class="mb-3">
                        <label for="save_path" class="form-label">Save Run Log Path</label>
                        <input type="text" id="save_path" class="form-control" placeholder="Enter folder path (optional)">
                    </div>
                    <button type="button" id="run-tests-btn" class="btn btn-primary" onclick="runTests()">Run All Tests</button>
                    <button type="button" id="stop-tests-btn" class="btn btn-danger" style="display: none;" onclick="stopTest()">Stop Test</button>
                </form>
            </div>
        </div>

        <!-- Test Progress Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Test Progress</h5>
                <div class="progress">
                    <div id="test-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </div>
        </div>

        <div id="result-section" style="display:none;" class="alert alert-success">
            <strong>Success!</strong> Results saved to: <span id="file-path"></span>
        </div>
    </div>

    <script>
        function runAllCommand() {
            const command = $("#custom-command").val();
            $("#command-output").html("<div class='loader'></div> Running command on all RPIs...");

            $.post("/run_command", { command: command }, function(results) {
                let output = "<h5>Command Output:</h5>";
                for (const [rpi, result] of Object.entries(results)) {
                    output += `<strong>${rpi}:</strong><pre>${result}</pre>`;
                }
                $("#command-output").html(output);
            });
        }

        function runTests() {
            const duration = $("#duration").val();
            const savePath = $("#save_path").val() || "{{ default_directory }}"; // Set default directory path

            if (!duration || duration <= 0) {
                alert("Please enter a valid duration in hours.");
                return;
            }

            $("#run-tests-btn").prop("disabled", true);
            $("#stop-tests-btn").show();

            $.post("/run_tests", {
                duration: duration,
                save_path: savePath
            }, function(response) {
                let filePathMessage = '';
                response.results.forEach(result => {
                    filePathMessage += result.rpi + " results saved to: " + result.path + "<br>";
                });
                $('#file-path').html(filePathMessage);
                $('#result-section').show();
                $("#run-tests-btn").prop("disabled", false);
                $("#stop-tests-btn").hide();
            });

            trackProgress(duration);
        }

        function fetchMetrics(ip) {
            $("#test-output-body").html('<tr><td colspan="7"><div class="loader"></div> Gathering vcgencmd metrics...</td></tr>');

            $.getJSON(`/metrics/${ip}`, function(data) {
                let testOutputBody = $("#test-output-body");
                testOutputBody.empty();  // Clear previous rows
                let newRow = `
                    <tr>
                        <td>${ip}</td>
                        <td>${data.core_voltage || 'N/A'}</td>
                        <td>${data.cpu_temp || 'N/A'}</td>
                        <td>${data.cpu_freq_mhz || 'N/A'}</td>
                        <td>${data.load_average || 'N/A'}</td>
                        <td>${data.memory_usage || 'N/A'}</td>
                        <td>${data.throttled_status || 'N/A'}</td>
                    </tr>
                `;
                testOutputBody.append(newRow);
            });
        }

        function trackProgress(duration) {
            const totalDuration = duration * 3600; // Convert to seconds

            let elapsed = 0;
            const interval = setInterval(function() {
                elapsed += 60; // Progress every minute
                const progressPercent = (elapsed / totalDuration) * 100;
                $("#test-progress-bar").css("width", progressPercent + "%").attr("aria-valuenow", progressPercent).text(Math.floor(progressPercent) + "%");

                if (elapsed >= totalDuration) {
                    clearInterval(interval);
                }
            }, 60000);  // Every minute
        }

        function stopTest() {
            // Stop the current test and re-enable the run tests button
            $("#stop-tests-btn").hide();
            $("#run-tests-btn").prop("disabled", false);
            $("#test-progress-bar").css("width", "0%").text("0%");
        }
    </script>
</body>
</html>
